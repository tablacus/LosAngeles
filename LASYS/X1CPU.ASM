;
;	L-os Angeles CPU
;
;	DISK I/O (CPU)
;
	ORG	DMA,$2700
;
CPU:
;
C_VER:
	LD	HL,$2080
	RET
;
C_RDFAT:
	CALL	C_RDFATS
	RET	C
	LD	HL,(_FATBF)
	LD	A,(HL)
	CP	(IY+DPB_FATID)
	JP	NZ,RDDERR
	OR	A
	RET
;
C_RDFATS:
	CALL	_DEVADR
;
	CALL	FATS
;
C_RDFATL:
	PUSH	BC
	CALL	_DRDC
	POP	BC
	RET	C
	DJNZ	C_RDFATL
	RET
;
C_WTTRK:
	LD	A,$F0
	JR	C_WTTRK1
;
C_DWTW:
	CALL	C_DWT		;512/sector
	RET	C
;
C_DWT:
	LD	A,$A0
C_WTTRK1:
	LD	(DWTPAT+1),A
;
	LD	A,5		;リトライカウント
	LD	(RETRY),A
;
DWT0:
	PUSH	DE
	PUSH	HL
	LD	(DHLPAT+1),HL
	CALL	SEEK		;ディスクライト
	POP	HL
	JR	C,ERRD
	DI
DWTPAT:
	LD	A,$A0
	CALL	SECSET
	LD	C,$FB
;
DWT1:
	LD	D,(HL)
DWT2:
	LD	A,B
	IN	A,($F8)
	RRCA
	JR	NC,DWT4
	RRCA
	JR	NC,DWT2
DWT3:
	OUT	(C),D
	INC	HL
	JP	DWT1
;
DWT4:
	DEC	A
	JR	Z,DWT3
	INC	A
	EI
	POP	DE
	INC	DE
	CALL	FDMOFF
	RET	Z
	CALL	DISKC
DWTN:
	JR	NZ,DWT0
	PUSH	DE
ERRD:
	POP	DE
ERRW:
	LD	A,$FF
ERRZ:
	CP	A
	SCF
	JP	FDMOFF
;
C_RDID:
	LD	A,$C0
	JR	C_RDID1
;
C_DRDW:
	CALL	C_DRD		;512/sector
	RET	C
;
C_DRD:
	LD	A,$80
C_RDID1:
	LD	(DRDPAT+1),A
	LD	(DWTPAT+1),A
;
	LD	A,5		;リトライカウント
	LD	(RETRY),A
;
DRD0:
	PUSH	DE
	PUSH	HL
	LD	(DHLPAT+1),HL
	CALL	SEEK		;ディスクリード
	POP	HL
	JR	C,ERRD
	DI
DRDPAT:
	LD	A,$80
	CALL	SECSET
	LD	C,$FB
DRD1:
	LD	A,B
	IN	A,($F8)
	RRCA
	JR	NC,DRD3
	RRCA
	JR	NC,DRD1
	INI
	INC	B
	JP	DRD1
;
DRD3:
	OR	A
	EI
	POP	DE
	INC	DE
	CALL	FDMOFF
	RET	Z
	CALL	DISKC
DRDN:
	JR	NZ,DRD0
	JR	ERRW
;
DISKC:
	DEC	DE
	BIT	3,A
	JR	NZ,C_RNF
DISKD:
	LD	HL,RETRY
	DEC	(HL)
DHLPAT:	LD	HL,0
	LD	A,$FF
	RET
;
C_RNF:
	LD	HL,(_DRIVE)
	LD	H,$1F
	LD	A,(HL)
	LD	(HL),$FF
	OR	A
	RET	Z
;
	LD	A,2
	LD	(_SEEKSP),A
	JR	DISKD
;
CPUE:
	ORG	SCR1,$2700+CPUE-CPU
AT_SCR1:
	EXX
	PUSH	BC
	LD	BC,02000H+80
	EXX
	PUSH	BC
	LD	BC,02000H

	LD	H,A
	OR	A
AT_SCRUP1:
	JR	Z,AT_SCRCL
	PUSH	BC
	SET	4,B
	EXX
	PUSH	BC
	SET	4,B
	EXX
	CALL	AT_UPSUB
	EXX
	POP	BC
	EXX
	POP	BC
	CALL	AT_UPSUB
	DEC	H
	JR	AT_SCRUP1

AT_SCRE: